$.fn.select2.defaults.set("theme","bootstrap");$.fn.select2.defaults.set("ajax--cache",!0);var partsManager=function(){var n={billBody:$("#listItems tbody"),billFooter:$("#listItems tfoot"),TotalAmount:$("#TotalAmount"),Discount:$("#Discount"),NetAmount:$("#NetAmount"),newLine:$(".newLine"),rowClone:'<tr><td class="itemdiv text-center"><span class="glyphicon glyphicon-resize-vertical movable"><\/span><span class="num">1<\/span><input type="hidden" name="childID" value="0" /><div class="tools"><a href="#delete" class="btn btn-xs btn-danger"><span class="glyphicon glyphicon-trash" aria-hidden="true"><\/span><\/a><\/div><\/td><td class="edit"><select name="ItemID" id="car_1" required class="input-block-level form-control select2 new cars" data-placeholder="'+lang.ChooseaCar+'"><option><\/option><\/select><\/td><td class="edit"><input name="PartName" required class="input-block-level form-control new" type="text"><\/td><td class="edit"><input name="Quantity" required class="input-block-level form-control number new" type="number" value="1"><\/td><td class="edit"><input name="Price" required class="input-block-level form-control money new" type="text" value="0"><\/td><td>0<\/td><\/tr>',invoiceID:$("#Id"),accountId:$("#AccountId"),invoiceTypeId:$("#InvoiceTypeId"),invoiceN:$("#InvoiceNo"),addDate:$("#AddDate"),notes:$("#Notes"),cSave:$("#btnSave"),form:"aspnetForm"},o=function(){var i="/Invoices/Edit/"+n.invoiceID.val(),r=function(i){var r=i.invoice,f=i.invoice.invoiceDetails,e;r&&($("#Discount").val(numeral(r.discount).format("0,0.00")),$("#InvoiceNo").val(r.invoiceNo),$("#AddDate").val(moment(r.addDate).format("MM/DD/YYYY")),$("#Notes").val(r.notes),e=new Option(r.account.title,r.accountId,!1,!1),$(n.accountId).append(e).trigger("change"));f&&(n.billBody.empty(),$(f).each(function(i,r){var f=i+1,u=$(n.rowClone.split("car_1").join("car_"+f)).clone(!0),s="#car_"+f,e,o;$(".num",u).text(f);$("[name='childID']",u).val(r.id||0);e={id:r.itemId,text:r.itemId+" - "+r.item.make.makeName+" "+r.item.model.modelName+" "+r.item.yearId};o=new Option(e.text,e.id,!1,!1);$("[name='ItemID']",u).append(o).trigger("change");$("[name='PartName']",u).val(r.partName);$("[name='Quantity']",u).val(r.quantity);$("[name='Price']",u).val(numeral(r.price).format("0,0.00"));$("td:eq(5)",u).text(numeral(r.subTotal).format("0,0.00"));n.billBody.append($(u));t(s,r.itemId)}).promise().done(function(){u()}))};dataService.callAjax("GET",{},i,r,commonManger.errorException)},s=function(){$(document).delegate('input[type="text"],input[type="number"]',"click",function(){$(this).select()});$(".today").datepicker("setDate",new Date);var i=commonManger.getUrlSegment();i&&i[5]&&(n.invoiceID.val(i[5]),o());$(".money").autoNumeric("init");n.billBody.sortable({opacity:.8,revert:!0,forceHelperSize:!0,placeholder:"draggable-placeholder",forcePlaceholderSize:!0,tolerance:"pointer",stop:function(n,t){$(t.item).css("z-index","auto");r()}});n.billBody.delegate('input[name="Quantity"],input[name="Price"]',"keyup",function(){var n=$(this).closest("tr"),t=numeral(n.find('input[name="Quantity"]').val()).value()*numeral(n.find('input[name="Price"]').val()).value();n.find("td:eq(5)").text(numeral(t).format("0,0.00"));u()});n.billFooter.delegate(n.Discount,"keyup",function(){e()});n.billBody.delegate("tr td.itemdiv a","click",function(n){n.preventDefault();var t=$(this).closest("tr");c(t)});n.newLine.on("click",function(i){var h;i.preventDefault();var e=n.billBody.children("tr").length+1,o=n.rowClone.split("car_1").join("car_"+e),s="#car_"+e;$(".num",o).text(e);n.billBody.append($(o));$(s).focus();t(s);r();$("input.new").each(function(){$(this).rules("add",{required:!0})});n.billBody.find('select[name="ItemID"]:last').focus();$(".money").autoNumeric("init");u();h=commonManger.applyValidation(n.form);h||commonManger.showMessage(lang.Required,lang.RequiredMsg,"warning");f()});n.billBody.delegate('input[name="Price"]:last',"blur",function(){n.newLine.trigger("click")});n.cSave.click(function(n){n.preventDefault();h()});t("#car_1");f();n.accountId.select2({placeholder:lang.PleaseChoose,dir:"rtl",language:"ar",allowClear:!0,ajax:{delay:150,cacheDataSource:[],url:"/Accounts/AccountByType",dataType:"json",async:!0,data:function(t){var i=n.invoiceTypeId.val(),r=parseInt(i*1)<3?1:2;return{pageSize:10,pageNum:t.page||1,searchTerm:t.term,invoiceType:r}},processResults:function(n,t){return t.page=t.page||1,{results:n.results,pagination:{more:t.page*10<=n.total}}}}})},h=function(){var t={id:n.invoiceID.val(),accountId:n.accountId.val(),invoiceTypeId:n.invoiceTypeId.val(),invoiceNo:n.invoiceN.val(),notes:n.notes.val(),totalAmount:numeral(n.TotalAmount.text()).value(),discount:numeral(n.Discount.val()).value(),tax:0,netAmount:numeral(n.NetAmount.text()).value(),userId:1,isCache:!0,addDate:n.addDate.val(),addTime:"00:00:00",invoiceDetails:[]},i=function(n){n.saved===!0?(commonManger.showMessage(lang.Success,lang.SuccessMessage,"success"),window.location.href=n.id>0?"/Invoices/Details/"+n.id:"/Invoices"):commonManger.showMessage(lang.Error,lang.SystemError+n.id,"error")};n.billBody.children("tr").each(function(i,r){var u=$(r),f={id:u.find("input:eq(0)").val(),invoiceId:n.invoiceID.val(),itemId:$("#car_"+(i+1)).val(),partName:u.find("input:eq(1)").val(),quantity:numeral(u.find("input:eq(2)").val()).value(),price:numeral(u.find("input:eq(3)").val()).value(),subTotal:numeral(u.find("td:last").text()).value()};f.itemId!==""&&f.partName!==""&&f.subTotal>0&&t.invoiceDetails.push(f)});t.accountId!==""&&t.invoiceDetails.length>0?commonManger.doWork(n.form,"/Invoices/Save",t,i):commonManger.showMessage(lang.Required,lang.RequiredMsg,"warning")},t=function(n,t){var i=$(n);i.hasClass("cars")?($(n).select2({placeholder:lang.ChooseACar,dir:"rtl",language:"ar",allowClear:!0,ajax:{delay:150,cacheDataSource:[],url:"/Invoices/GetCars",dataType:"json",async:!0,data:function(n){return{pageSize:10,pageNum:n.page||1,searchTerm:n.term}},processResults:function(n,t){return t.page=t.page||1,{results:n.results,pagination:{more:t.page*10<=n.total}}}}}),t&&$(n).val(t).trigger("change")):$(n).select2({language:"ar",allowClear:!0,dir:"rtl"})},i=function(n){var t=$(n),i=t.val(),r=t.closest("td");i!==""&&r.next("td").find("input").select()},f=function(){$("select.cars.select2").on("select2:close",function(){return i(this),!1});jQuery('input[name="PartName"]').bind("keydown.return",function(){return i(this),!1});jQuery('input[name="Quantity"]').bind("keydown.return",function(){return i(this),!1});jQuery('input[name="Price"]').bind("keydown.return",function(){return n.newLine.trigger("click"),!1})},r=function(){n.billBody.find("tr").each(function(n){$(this).find("span.num").text(n+1)})},c=function(n){n.css({transition:"background-color 1s","background-color":"red"}).fadeOut("slow").promise().done(function(){n.remove();r()})},e=function(){var t=numeral(n.TotalAmount.text()).value()-numeral(n.Discount.val()).value();n.NetAmount.text(numeral(t).format("0,0.00"))},u=function(){var t=0;n.billBody.children("tr").each(function(){t+=numeral($(this).find("td:eq(5)").text()).value()}).promise().done(function(){n.TotalAmount.text(numeral(t).format("0,0.00"));e()})};return{Init:s}}();partsManager.Init();