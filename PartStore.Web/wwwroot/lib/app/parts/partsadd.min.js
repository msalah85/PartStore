$.fn.select2.defaults.set("theme","bootstrap");var partsManager=function(){var n={billBody:$("#listItems tbody"),billFooter:$("#listItems tfoot"),TotalAmount:$("#TotalAmount"),Discount:$("#Discount"),NetAmount:$("#NetAmount"),newLine:$(".newLine"),rowClone:'<tr><td class="itemdiv text-center"><span class="glyphicon glyphicon-resize-vertical movable"><\/span><span class="num">1<\/span><input type="hidden" name="childID" value="0" /><div class="tools"><a href="#delete" class="btn btn-xs btn-danger"><span class="glyphicon glyphicon-trash" aria-hidden="true"><\/span><\/a><\/div><\/td><td class="edit"><select name="ItemID" id="car_1" required class="input-block-level form-control select2 new cars" data-placeholder="'+lang.ChooseaCar+'"><\/select><\/td><td class="edit"><input name="PartName" required class="input-block-level form-control new" type="text"><\/td><td class="edit"><input name="Quantity" required class="input-block-level form-control number new" type="number" value="1"><\/td><td class="edit"><input name="Price" required class="input-block-level form-control money new" type="text" value="0"><\/td><td>0<\/td><\/tr>',invoiceID:$("#Id"),accountId:$("#AccountId"),invoiceTypeId:$("#InvoiceTypeId"),invoiceN:$("#InvoiceNo"),addDate:$("#AddDate"),notes:$("#Notes"),cSave:$("#btnSave"),form:"aspnetForm"},s=function(){var t="/Invoices/Edit/"+n.invoiceID.val(),i=function(t){var i=t.invoice,e=t.invoice.invoiceDetails;i&&($("#Discount").val(numeral(i.discount).format("0,0.00")),$("#InvoiceNo").val(i.invoiceNo),$("#AddDate").val(moment(i.addDate).format("MM/DD/YYYY")),$("#Notes").val(i.notes),$(n.accountId).val(i.accountId).trigger("change"));e&&(n.billBody.empty(),$(e).each(function(t,i){var u=t+1,r=$(n.rowClone.split("car_1").join("car_"+u)).clone(!0),e="#car_"+u;$(".num",r).text(u);$("[name='childID']",r).val(i.id||0);$("[name='ItemID']",r).val(i.itemId).trigger("change");$("[name='PartName']",r).val(i.partName);$("[name='Quantity']",r).val(i.quantity);$("[name='Price']",r).val(numeral(i.price).format("0,0.00"));$("td:eq(5)",r).text(numeral(i.subTotal).format("0,0.00"));n.billBody.append($(r));f(e,i.itemId)}).promise().done(function(){r();u()}))};dataService.callAjax("GET",{},t,i,commonManger.errorException)},h=function(){$(document).delegate('input[type="text"],input[type="number"]',"click",function(){$(this).select()});$(".today").datepicker("setDate",new Date);var t=commonManger.getUrlSegment();t&&t[5]&&(n.invoiceID.val(t[5]),s());u();$(".money").autoNumeric("init");n.billBody.sortable({opacity:.8,revert:!0,forceHelperSize:!0,placeholder:"draggable-placeholder",forcePlaceholderSize:!0,tolerance:"pointer",stop:function(n,t){$(t.item).css("z-index","auto");i()}});n.billBody.delegate('input[name="Quantity"],input[name="Price"]',"keyup",function(){var n=$(this).closest("tr"),t=numeral(n.find('input[name="Quantity"]').val()).value()*numeral(n.find('input[name="Price"]').val()).value();n.find("td:eq(5)").text(numeral(t).format("0,0.00"));r()});n.billFooter.delegate(n.Discount,"keyup",function(){o()});n.billBody.delegate("tr td.itemdiv a","click",function(n){n.preventDefault();var t=$(this).closest("tr");l(t)});n.newLine.on("click",function(t){var h;t.preventDefault();var u=n.billBody.children("tr").length+1,o=n.rowClone.split("car_1").join("car_"+u),s="#car_"+u;$(".num",o).text(u);n.billBody.append($(o));$(s).focus();f(s);i();$("input.new").each(function(){$(this).rules("add",{required:!0})});n.billBody.find('select[name="ItemID"]:last').focus();$(".money").autoNumeric("init");r();h=commonManger.applyValidation(n.form);h||commonManger.showMessage(lang.Required,lang.RequiredMsg,"warning");e()});n.billBody.delegate('input[name="Price"]:last',"blur",function(){n.newLine.trigger("click")});n.cSave.click(function(n){n.preventDefault();c()});e()},c=function(){var t={id:n.invoiceID.val(),accountId:n.accountId.val(),invoiceTypeId:n.invoiceTypeId.val(),invoiceNo:n.invoiceN.val(),notes:n.notes.val(),totalAmount:numeral(n.TotalAmount.text()).value(),discount:numeral(n.Discount.val()).value(),tax:0,netAmount:numeral(n.NetAmount.text()).value(),userId:1,isCache:!0,addDate:n.addDate.val(),addTime:"00:00:00",invoiceDetails:[]},i=function(n){n.saved===!0?(commonManger.showMessage(lang.Success,lang.SuccessMessage,"success"),window.location.href=n.id>0?"/Invoices/Details/"+n.id:"/Invoices"):commonManger.showMessage(lang.Error,lang.SystemError+n.id,"error")};n.billBody.children("tr").each(function(i,r){var u=$(r),f={id:u.find("input:eq(0)").val(),invoiceId:n.invoiceID.val(),itemId:$("#car_"+(i+1)).val(),partName:u.find("input:eq(1)").val(),quantity:numeral(u.find("input:eq(2)").val()).value(),price:numeral(u.find("input:eq(3)").val()).value(),subTotal:numeral(u.find("td:last").text()).value()};f.itemId!==""&&f.partName!==""&&f.subTotal>0&&t.invoiceDetails.push(f)});t.accountId!==""&&t.invoiceDetails.length>0?commonManger.doWork(n.form,"/Invoices/Save",t,i):commonManger.showMessage(lang.Required,lang.RequiredMsg,"warning")},u=function(){$(".select2").select2({placeholder:lang.PleaseChoose,allowClear:!0,dir:"rtl"})},f=function(n,t){var i=$(n);i.hasClass("cars")?($(n).select2({placeholder:lang.ChooseACar,allowClear:!0,data:avialableCars,dir:"rtl"}),t&&$(n).val(t).trigger("change")):$(n).select2({allowClear:!0,dir:"rtl"})},t=function(n){var t=$(n),i=t.val(),r=t.closest("td");i!==""&&r.next("td").find("input").select()},e=function(){$("select.cars.select2").on("select2:close",function(){return t(this),!1});jQuery('input[name="PartName"]').bind("keydown.return",function(){return t(this),!1});jQuery('input[name="Quantity"]').bind("keydown.return",function(){return t(this),!1});jQuery('input[name="Price"]').bind("keydown.return",function(){return n.newLine.trigger("click"),!1})},i=function(){n.billBody.find("tr").each(function(n){$(this).find("span.num").text(n+1)})},l=function(n){n.css({transition:"background-color 1s","background-color":"red"}).fadeOut("slow").promise().done(function(){n.remove();i()})},o=function(){var t=numeral(n.TotalAmount.text()).value()-numeral(n.Discount.val()).value();n.NetAmount.text(numeral(t).format("0,0.00"))},r=function(){var t=0;n.billBody.children("tr").each(function(){t+=numeral($(this).find("td:eq(5)").text()).value()}).promise().done(function(){n.TotalAmount.text(numeral(t).format("0,0.00"));o()})};return{Init:h}}();partsManager.Init();